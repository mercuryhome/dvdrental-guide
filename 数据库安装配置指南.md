# PostgreSQL 17 数据库安装与配置指南

## 目录
1. [系统要求](#系统要求)
2. [PostgreSQL 17 安装](#postgresql-17-安装)
3. [数据库管理工具安装](#数据库管理工具安装)
4. [DVD租赁数据库安装](#dvd租赁数据库安装)
5. [环境配置与测试](#环境配置与测试)
6. [常见问题解决](#常见问题解决)

---

## 系统要求

### 硬件要求
- **内存**: 最少 512MB，推荐 2GB 以上
- **硬盘**: 至少 1GB 可用空间
- **处理器**: 支持 64 位的现代处理器

### 操作系统支持
- **Windows**: Windows 10/11, Windows Server 2016+
- **macOS**: macOS 10.15 (Catalina) 或更高版本
- **Linux**: Ubuntu 18.04+, CentOS 7+, RHEL 7+

---

## PostgreSQL 17 安装

### Windows 安装

#### 方法一：官方安装包
1. 访问 [PostgreSQL 官网](https://www.postgresql.org/download/windows/)
2. 下载 PostgreSQL 17 Windows 安装包
3. 运行安装程序，按以下步骤操作：
   ```
   - 选择安装路径（默认：C:\Program Files\PostgreSQL\17）
   - 选择数据目录（默认：C:\Program Files\PostgreSQL\17\data）
   - 设置超级用户密码（postgres）
   - 选择端口（默认：5432）
   - 选择语言环境（默认：Default locale）
   - 安装 pgAdmin 4（推荐）
   - 安装 Stack Builder（可选）
   ```

#### 方法二：使用包管理器
```powershell
# 使用 Chocolatey
choco install postgresql17

# 使用 Scoop
scoop install postgresql17
```

### macOS 安装

#### 方法一：使用 Homebrew（推荐）
```bash
# 安装 Homebrew（如果未安装）
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# 安装 PostgreSQL 17
brew install postgresql@17

# 启动 PostgreSQL 服务
brew services start postgresql@17

# 创建数据库用户
createuser -s postgres
```

#### 方法二：官方安装包
1. 访问 [PostgreSQL 官网](https://www.postgresql.org/download/macosx/)
2. 下载 macOS 安装包
3. 运行安装程序

### Linux 安装

#### Ubuntu/Debian
```bash
# 更新包列表
sudo apt update

# 安装 PostgreSQL 17
sudo apt install postgresql-17 postgresql-client-17

# 启动服务
sudo systemctl start postgresql
sudo systemctl enable postgresql

# 切换到 postgres 用户
sudo -u postgres psql
```

#### CentOS/RHEL
```bash
# 安装 PostgreSQL 官方仓库
sudo dnf install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-8-x86_64/pgdg-redhat-repo-latest.noarch.rpm

# 安装 PostgreSQL 17
sudo dnf install -y postgresql17-server postgresql17

# 初始化数据库
sudo /usr/pgsql-17/bin/postgresql-17-setup initdb

# 启动服务
sudo systemctl enable postgresql-17
sudo systemctl start postgresql-17
```

---

## 数据库管理工具安装

### pgAdmin 4（推荐）

#### Windows
- 安装 PostgreSQL 时选择安装 pgAdmin 4
- 或从 [pgAdmin 官网](https://www.pgadmin.org/download/) 单独下载

#### macOS
```bash
# 使用 Homebrew
brew install --cask pgadmin4

# 或从官网下载
```

#### Linux
```bash
# Ubuntu/Debian
sudo apt install pgadmin4

# CentOS/RHEL
sudo dnf install pgadmin4
```

### DBeaver（替代选择）

#### 所有平台
1. 访问 [DBeaver 官网](https://dbeaver.io/download/)
2. 下载对应平台的安装包
3. 安装并启动

### 命令行工具
```bash
# 连接到数据库
psql -h localhost -U postgres -d postgres

# 查看帮助
psql --help
```

---

## DVD租赁数据库安装

### 1. 下载数据库文件
```bash
# 创建下载目录
mkdir -p ~/Downloads/dvdrental
cd ~/Downloads/dvdrental

# 下载数据库文件（使用 wget 或 curl）
wget https://www.postgresqltutorial.com/wp-content/uploads/2019/05/dvdrental.zip

# 或使用 curl
curl -O https://www.postgresqltutorial.com/wp-content/uploads/2019/05/dvdrental.zip
```

### 2. 解压数据库文件
```bash
# 解压 zip 文件
unzip dvdrental.zip

# 验证文件
ls -la dvdrental.tar
```

### 3. 创建数据库
```bash
# 方法一：使用命令行
createdb -U postgres dvdrental

# 方法二：使用 psql
psql -U postgres -c "CREATE DATABASE dvdrental;"
```

### 4. 恢复数据库
```bash
# 使用 pg_restore 恢复数据库
pg_restore -U postgres -d dvdrental dvdrental.tar

# 如果遇到权限问题，使用以下命令
pg_restore -U postgres -d dvdrental -v dvdrental.tar
```

### 5. 验证安装
```sql
-- 连接到 dvdrental 数据库
psql -U postgres -d dvdrental

-- 查看所有表
\dt

-- 查看表结构
\d actor

-- 查询数据
SELECT COUNT(*) FROM film;
SELECT COUNT(*) FROM actor;
SELECT COUNT(*) FROM customer;
```

---

## 环境配置与测试

### 1. 配置 PostgreSQL 服务

#### Windows
```cmd
# 启动服务
net start postgresql-x64-17

# 停止服务
net stop postgresql-x64-17

# 查看服务状态
sc query postgresql-x64-17
```

#### macOS
```bash
# 启动服务
brew services start postgresql@17

# 停止服务
brew services stop postgresql@17

# 查看服务状态
brew services list | grep postgresql
```

#### Linux
```bash
# 启动服务
sudo systemctl start postgresql

# 停止服务
sudo systemctl stop postgresql

# 查看服务状态
sudo systemctl status postgresql

# 设置开机自启
sudo systemctl enable postgresql
```

### 2. 配置连接参数

#### 编辑 postgresql.conf
```bash
# 找到配置文件位置
sudo -u postgres psql -c "SHOW config_file;"

# 编辑配置文件
sudo nano /etc/postgresql/17/main/postgresql.conf
```

#### 主要配置项
```conf
# 监听地址
listen_addresses = 'localhost'

# 端口
port = 5432

# 最大连接数
max_connections = 100

# 共享缓冲区
shared_buffers = 128MB

# 工作内存
work_mem = 4MB
```

#### 编辑 pg_hba.conf
```bash
# 编辑认证配置文件
sudo nano /etc/postgresql/17/main/pg_hba.conf
```

#### 添加本地连接配置
```conf
# 本地连接
local   all             postgres                                peer
local   all             all                                     md5
host    all             all             127.0.0.1/32            md5
host    all             all             ::1/128                 md5
```

### 3. 重启服务
```bash
# 重启 PostgreSQL 服务
sudo systemctl restart postgresql

# 或使用以下命令
sudo service postgresql restart
```

### 4. 测试连接
```bash
# 测试本地连接
psql -h localhost -U postgres -d dvdrental

# 测试特定用户连接
psql -h localhost -U postgres -d dvdrental -c "SELECT version();"
```

---

## 常见问题解决

### 1. 连接被拒绝
```bash
# 检查服务状态
sudo systemctl status postgresql

# 检查端口是否被占用
sudo netstat -tlnp | grep 5432

# 检查防火墙设置
sudo ufw status
```

### 2. 认证失败
```bash
# 重置 postgres 用户密码
sudo -u postgres psql -c "ALTER USER postgres PASSWORD 'newpassword';"

# 检查 pg_hba.conf 配置
sudo cat /etc/postgresql/17/main/pg_hba.conf
```

### 3. 数据库恢复失败
```bash
# 检查文件权限
ls -la dvdrental.tar

# 使用详细模式恢复
pg_restore -U postgres -d dvdrental -v dvdrental.tar

# 清理并重新创建数据库
dropdb -U postgres dvdrental
createdb -U postgres dvdrental
pg_restore -U postgres -d dvdrental dvdrental.tar
```

### 4. 内存不足
```bash
# 调整共享缓冲区大小
sudo nano /etc/postgresql/17/main/postgresql.conf

# 修改以下配置
shared_buffers = 256MB
work_mem = 8MB
maintenance_work_mem = 64MB
```

### 5. 权限问题
```bash
# 修改数据目录权限
sudo chown -R postgres:postgres /var/lib/postgresql/17/main

# 修改配置文件权限
sudo chown postgres:postgres /etc/postgresql/17/main/postgresql.conf
sudo chmod 600 /etc/postgresql/17/main/postgresql.conf
```

---

## 性能优化建议

### 1. 基础配置优化
```conf
# postgresql.conf 优化配置
shared_buffers = 256MB
effective_cache_size = 1GB
work_mem = 8MB
maintenance_work_mem = 64MB
checkpoint_completion_target = 0.9
wal_buffers = 16MB
default_statistics_target = 100
```

### 2. 连接池配置
```bash
# 安装 pgbouncer
sudo apt install pgbouncer

# 配置连接池
sudo nano /etc/pgbouncer/pgbouncer.ini
```

### 3. 监控配置
```bash
# 启用统计收集
sudo -u postgres psql -c "ALTER SYSTEM SET track_activities = on;"
sudo -u postgres psql -c "ALTER SYSTEM SET track_counts = on;"
sudo -u postgres psql -c "SELECT pg_reload_conf();"
```

---

## 学习资源

### 官方文档
- [PostgreSQL 17 官方文档](https://www.postgresql.org/docs/17/)
- [PostgreSQL 教程](https://www.postgresqltutorial.com/)

### 在线资源
- [PostgreSQL 练习平台](https://pgexercises.com/)
- [SQL 在线练习](https://www.w3schools.com/sql/)

### 书籍推荐
- 《PostgreSQL 实战》
- 《SQL 必知必会》
- 《数据库系统概念》

---

## 总结

本指南提供了 PostgreSQL 17 的完整安装和配置流程，包括：

1. **系统要求检查**：确保硬件和软件环境满足要求
2. **PostgreSQL 安装**：支持 Windows、macOS 和 Linux 平台
3. **管理工具安装**：pgAdmin 4 和 DBeaver 的安装配置
4. **示例数据库安装**：DVD 租赁数据库的下载和恢复
5. **环境配置**：服务配置、连接参数和性能优化
6. **问题解决**：常见问题的诊断和解决方法

按照本指南操作，您将能够成功搭建 PostgreSQL 17 学习环境，为后续的 SQL 实验做好准备。

---

*如有问题，请参考官方文档或寻求社区支持。*
